# 右键菜单集成（Windows）

本项目提供 PowerShell 脚本，将以下两项加入到 PDF 文件的右键菜单（当前用户）：

- 用 winpiaojet 打开（并导入所选 PDF）
- 打印到 A4 上半张（winpiaojet）（静默打印，使用应用内默认模板/默认打印机）

## 安装

1. 确保已存在可执行文件：
   - 发布版：`dist/win-x64/winpiaojet.exe`
   - 或开发版：`src/Pdftools.Desktop/bin/(Debug|Release)/net8.0-windows10.0.19041.0/Pdftools.Desktop.exe`
2. 打开 PowerShell，执行：

```
powershell -ExecutionPolicy Bypass -File scripts/install-context-menu.ps1 -ExePath dist\win-x64\winpiaojet.exe
```

路径需要显式提供：
- 方式一：运行时通过 `-ExePath` 传入完整 exe 路径（推荐）。
- 方式二：打开脚本，在 `$ExePathManual` 中手动填写完整 exe 路径后再执行。
（脚本已简化：不再自动探测路径）

## 注册表修改明细（可追溯）

- 根路径（当前用户）：`HKCU:\Software\Classes\SystemFileAssociations\.pdf\shell`
  - `winpiaojet_open`
    - 默认值（REG_SZ）：`用 winpiaojet 打开`
    - `Icon`（REG_SZ）：`<exe路径>,0`（使用 EXE 图标）
    - `MultiSelectModel`（REG_SZ）：`Player`（支持多选）
    - 子键：`command`
      - 默认值（REG_SZ）：`"<exe路径>" "%*"`
  - `winpiaojet_print`
    - 默认值（REG_SZ）：`打印到 A4 上半张（winpiaojet）`
    - `Icon`（REG_SZ）：`<exe路径>,0`
    - `MultiSelectModel`（REG_SZ）：`Player`
    - 子键：`command`
      - 默认值（REG_SZ）：`"<exe路径>" --print "%*"`

说明：
- 脚本会在缺失时自动创建上级键：`HKCU:\Software\Classes` → `SystemFileAssociations` → `.pdf` → `shell`。
- 此为“经典右键菜单”项；在 Windows 11 需点击“显示更多选项”展示。若需出现在新式第一层，需要 IExplorerCommand 方案（本项目暂不覆盖）。

## 卸载

可任选其一：

1) 使用安装脚本的卸载开关：
```
powershell -ExecutionPolicy Bypass -File scripts/install-context-menu.ps1 -Remove
```

2) 使用独立卸载脚本：
```
powershell -ExecutionPolicy Bypass -File scripts/uninstall-context-menu.ps1
```

## 多选与兼容性

- 已设置 `MultiSelectModel=Player`，命令使用 `"%1"`（而非 `%*`）。Explorer 在多选时会把其余文件自动追加到命令行参数中。
- Windows 11 新式右键菜单默认折叠为“显示更多选项”；本脚本注册为经典菜单项，需展开后可见。若需出现在第一层新式菜单，需实现 Explorer 命令（IExplorerCommand/ExplorerCommandHandler），后续可按需扩展。

## 静默打印注意事项

- 右键“打印到 A4 上半张”使用应用内默认打印机/模板：首次请在应用中选择打印机，并在预览显示后自动保存为默认。
- 可通过命令行覆盖参数（脚本命令固定）示例：`winpiaojet.exe --print --printer "HP LaserJet" --template default --dpi 300 "file.pdf"`

