# C# 代码审查报告与修复计划（pdftools）

> 日期：2025-09-20  晚班审查

## 背景与症状
- 日志显示启动自检阶段发生 PDF 渲染失败：`System.IO.IOException: 请求的操作无法在使用用户映射区域打开的文件上执行`（用户映射文件冲突）。
- 旧版本实现将自检 PDF 落盘到 `Temp` 再由 WinRT 渲染，触发内存映射文件与覆盖写入的冲突。
- 当前仓库代码已改为“全内存管道”（MemoryStream → IRandomAccessStream → PdfDocument），方向正确，但仍存在若干稳健性与性能隐患。

## 根因结论
- Windows.Data.Pdf 基于内存映射（或等效机制）读取 PDF；同一路径被再次写入/覆盖时会报错。彻底规避方式是：自检与预览均走内存流，不落磁盘，或确保文件不被二次打开/覆盖。

---

## 问题清单（按优先级）

### P0（立即修复）
1) 自检签名与异常处理不规范（启动路径）  
   - 位置：`src/Pdftools.Desktop/App.xaml.cs:58`（`async void SelfCheck()`）  
   - 问题：`async void` 无法被 `await` 与统一捕获；启动期弹窗打断体验。  
   - 建议：改为 `async Task SelfCheck()`，在 `OnStartup` 中 `await`；失败仅写日志或延后到主窗体 Ready 后非阻塞提示。

2) 自检内存复制不必要  
   - 位置：`src/Pdftools.Desktop/App.xaml.cs` 自检内写入 `DataWriter.WriteBytes(msPdf.ToArray())`  
   - 问题：整包复制产生额外 GC 压力。  
   - 建议：用 `msPdf.AsRandomAccessStream()`（WindowsRuntimeStreamExtensions）直转 WinRT 流；或分块写入。

### P1（高优先级）
3) WindowsPdfRenderer 资源释放与 API 设计不足  
   - 位置：`src/Pdftools.Desktop/Services/WindowsPdfRenderer.cs:13,18`  
   - 问题：仅支持文件路径；`page`/中间流未显式 `using`；长宽分别 Round 可能引入 1px 误差。  
   - 建议：
     - 新增 `RenderPageAsync(Stream stream, int pageIndex, int dpi)` 重载，统一走内存；路径版用 `File.OpenRead` 包装为流后复用。
     - `using var page = doc.GetPage(...);`、`using var ms = new MemoryStream();`；由一侧长宽推导另一侧，避免双向 Round。

4) 打印路径并发句柄与高 DPI 占用  
   - 位置：`src/Pdftools.Desktop/Services/PrintServiceSystem.cs`  
   - 问题：同一流程既用 PdfSharp 读尺寸、又用 WinRT 渲染同一路径，增大跨库句柄冲突概率；固定 600 DPI 位图在 A4 上内存占用很高。  
   - 建议：统一来源（优先从 WinRT `PdfDocument.Dimensions` 取尺寸，或先读后释放再渲染）；预览 150–300 DPI，打印 300–600 DPI 动态计算；(file,page,dpi) 结果缓存；在 `PrintTicket` 侧确保驱动不做二次缩放。

5) QPDF 调用器稳健性  
   - 位置：`src/Pdftools.Desktop/Services/QpdfRunner.cs:12,27`  
   - 问题：`WaitForExit(2000)` 超时未 Kill；`ExitCode` 在未退出时访问风险；`Path.GetDirectoryName(output)` 可能为 null；纯同步可能阻塞 UI。  
   - 建议：超时 Kill/返回 false；访问前判断 `HasExited`；输出目录判空再创建；补充 `CompressAsync` 版本并设置总体超时。

### P2（中优先级）
6) IPdfRenderer 桩实现掩盖逻辑错误  
   - 位置：`src/Pdftools.Core/Services/PdfRendererStub.cs`  
   - 问题：`IsA5Like` 永远返回 true。  
   - 建议：提供最小可用实现（基于 WinRT 尺寸计算），或在桌面层注入真实实现适配器。

7) PDF 操作与预览的并发安全  
   - 位置：`src/Pdftools.Core/PdfOps/*`  
   - 问题：若预览占用（WinRT 映射）时进行 Modify/Save 可能失败。  
   - 建议：操作前关闭预览句柄或复制到临时文件进行处理后 Replace。

8) 字体与可移植性  
   - 位置：`PageNumberService`/`WatermarkService`（Arial）  
   - 问题：目标机缺字/未嵌入导致渲染差异或异常。  
   - 建议：支持可配置字体/内置私有字体，启用嵌入。

9) 设置/模板持久化的原子性与可观测性  
   - 位置：`SettingsService`、`TemplateService`  
   - 问题：直接覆盖写，无原子替换与异常日志；并发写可能丢数据。  
   - 建议：临时文件写入 → 原子替换；异常写入日志。

10) 预览交互性能  
   - 位置：`src/Pdftools.Desktop/MainWindow.xaml.cs:542`  
   - 问题：参数每次变更重新渲染第一页，未缓存。  
   - 建议：基于 `(file,page,dpi)` 的位图缓存；仅定位变更时复用位图。

11) UX 与异常  
   - 启动期弹窗影响体验；建议降级为状态栏提示或延后提示。统一 `RunSafeAsync` 包装后台任务并写结构化日志。

---

## To-Do 任务清单（可执行）
- [ ] 自检：改 `async Task SelfCheck()`，在 `OnStartup` await；失败仅日志不弹窗。
- [ ] 自检：用 `AsRandomAccessStream` 替换 `ToArray()+DataWriter`。
- [ ] Renderer：新增 `RenderPageAsync(Stream, ...)` 重载；补齐 `using`；宽高由一侧推导另一侧。
- [ ] 打印：统一获取尺寸来源；读取后立即释放句柄；预览/打印 DPI 动态化；添加位图缓存与驱动缩放控制。
- [ ] QPDF：`IsAvailable()` 超时 Kill/判断 `HasExited`；`Compress` 目录判空与总超时；增加 `CompressAsync`。
- [ ] Core 渲染：提供 `IPdfRenderer` 的最小可用实现（WinRT 尺寸）。
- [ ] PDF 操作并发：预览占用时改为临时文件中转再 Replace。
- [ ] 字体：支持可配置/内置字体并嵌入，避免缺字。
- [ ] 设置/模板：采用原子写与异常日志，避免静默失败。
- [ ] 预览：加入 (file,page,dpi) 缓存与节流。
- [ ] 文档：更新用户手册“预览与打印策略”“qpdf 依赖说明”。
- [ ] 测试：补充布局/尺寸计算的单元测试，覆盖边界情况。

## 执行顺序建议（里程碑）
1. 里程碑A：自检与渲染稳定性（P0+P1-Renderer）
2. 里程碑B：打印体验与性能（打印服务、预览缓存）
3. 里程碑C：工具链稳健性（QPDF、并发安全、持久化）
4. 里程碑D：功能完善（IPdfRenderer、字体策略）

## 验收标准
- 启动自检不再出现文件映射冲突；失败仅日志无打断弹窗。
- 同一 PDF 在预览、打印与操作之间无文件句柄冲突；多次切换参数不卡顿。
- 大尺寸文档预览内存峰值显著下降（预览 ≤300DPI），打印质量保持稳定（300–600DPI）。
- QPDF 调用在缺失/超时时稳健降级并输出可读日志。
- 设置/模板写入具备原子性，异常有日志可追踪。

---

## 附：主要文件与参考位置
- `src/Pdftools.Desktop/App.xaml.cs:58`（自检入口）
- `src/Pdftools.Desktop/Services/WindowsPdfRenderer.cs:13,18`（渲染器）
- `src/Pdftools.Desktop/Services/PrintServiceSystem.cs`（打印路径与 DPI）
- `src/Pdftools.Desktop/Services/QpdfRunner.cs:12,27`（qpdf 调用）
- `src/Pdftools.Core/Services/PdfRendererStub.cs`（渲染桩实现）
- `src/Pdftools.Core/PdfOps/*`（PDF 基础操作）
- `src/Pdftools.Core/Services/SettingsService.cs`、`TemplateService.cs`（持久化）
- `src/Pdftools.Desktop/MainWindow.xaml.cs:542`（预览渲染触发）

> 说明：行号基于当前提交近似定位，个别变动以实际代码为准。

